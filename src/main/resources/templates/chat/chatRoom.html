<!DOCTYPE html>
<html
  lang="kr"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <title th:text="${room.member.nickname}"></title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <!-- CSS -->
    <link
      rel="stylesheet"
      href="/webjars/bootstrap/4.3.1/dist/css/bootstrap.min.css"
    />
  </head>
  <body>
    <div class="container">
      <div class="col-6">
        <h1 th:text="${room.member.nickname}"></h1>
      </div>
      <div>
        <div id="msgArea" class="col"></div>
        <div class="col-6">
          <div class="input-group mb-3">
            <input type="text" id="message" class="form-control" />
            <div class="input-group-append">
              <button
                class="btn btn-outline-secondary"
                type="button"
                id="button-send"
              >
                전송
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6"></div>
    </div>
    <!-- JavaScript -->
    <script th:src="@{/webjars/sockjs-client/1.1.2/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/2.3.3-1/stomp.min.js}"></script>
    <script
      th:src="@{https://code.jquery.com/jquery-3.6.1.min.js}"
      integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
      crossorigin="anonymous"
    ></script>
    <script th:inline="javascript">
      window.addEventListener("DOMContentLoaded", () => {
                let roomName = [[${room.member.nickname}]];
                let roomId = [[${room.roomId}]];
                let username = [[${room.member.nickname}]];
                let msgArea = document.querySelector("#msgArea");

                console.log(roomName + ", " + roomId + ", " + username);

                let sockJs = new SockJS("/stomp/chat");
                //1. SockJS를 내부에 들고있는 stomp를 내어줌
                let stomp = Stomp.over(sockJs);

                //2. connection이 맺어지면 실행
                stomp.connect({}, function (){
                   console.log("STOMP Connection")

                   //4. subscribe(path, callback)으로 메세지를 받을 수 있음
                   stomp.subscribe("/sub/chat/room/" + roomId, function (chat) {
                       let content = JSON.parse(chat.body);

                       let writer = content.writer;
                       let str = '';
                       let message = content.message;
                       if(writer == username){
                           str = "<div class='col-6'>";
                           str += "<div class='alert alert-secondary'>";
                           str += "<b>" + writer + " : " + message + "</b>";
                           str += "</div></div>";
                           $("#msgArea").append(str);

                       }
                       else{
                           str = "<div class='col-6'>";
                           str += "<div class='alert alert-warning'>";
                           str += "<b>" + writer + " : " + message + "</b>";
                           str += "</div></div>";
                           $("#msgArea").append(str);
                       }
                   });


                   //3. send(path, header, message)로 메세지를 보낼 수 있음
                //    stomp.send('/pub/chat/enter', {}, JSON.stringify({roomId: roomId, writer: username}))
                });


                const sendButton = document.querySelector("#button-send")
                sendButton.addEventListener("click",function(e){
                  let message = document.getElementById("message");

                  console.log(username + ":" + message.value);
                  stomp.send('/pub/chat/message', {}, JSON.stringify({roomId: roomId, message: message.value, writer: username}));
                  message.value = '';
                })
            });
    </script>
    <!-- JavaScript Bundle with Popper -->
    <script
      th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js}"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
